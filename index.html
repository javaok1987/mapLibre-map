<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MapLibre GL JS 3D åœ°åœ–ç¯„ä¾‹</title>

    <!-- å¼•å…¥ MapLibre GL JS çš„ CSS -->
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />

    <!-- å¼•å…¥ Tailwind CSS ç”¨æ–¼å¿«é€Ÿæ’ç‰ˆ UI -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      /* è‡ªå®šç¾© Popup æ¨£å¼ */
      .maplibregl-popup-content {
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        font-family: "Noto Sans TC", sans-serif;
      }
      .maplibregl-popup-close-button {
        font-size: 16px;
        color: #666;
        padding: 5px 8px;
      }
    </style>
  </head>
  <body>
    <!-- åœ°åœ–å®¹å™¨ -->
    <div id="map"></div>

    <!-- æµ®å‹•æ§åˆ¶é¢æ¿ (UI) -->
    <div
      class="absolute top-4 left-4 bg-white/90 backdrop-blur-sm p-4 rounded-lg shadow-lg max-w-xs z-10 border border-gray-200"
    >
      <div class="flex flex-col gap-2">
        <button
          onclick="resetView()"
          class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded transition text-sm font-medium"
        >
          ğŸ“ é‡ç½®è¦–è§’ (å°åŒ—101)
        </button>
        <button
          onclick="resetToInitialView()"
          class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded transition text-sm font-medium"
        >
          ğŸŒ å›åˆ°åˆå§‹è¦–è§’
        </button>
      </div>

      <div class="mt-4 text-xs text-gray-500">
        <p>ğŸ’¡ æ“ä½œæç¤ºï¼š</p>
        <ul class="list-disc pl-4 mt-1 space-y-1">
          <li>æŒ‰ä½ <b>å³éµ</b> æ‹–æ›³å¯å‚¾æ–œ/æ—‹è½‰</li>
          <li>æŒ‰ä½ <b>Ctrl + å·¦éµ</b> äº¦å¯</li>
        </ul>
      </div>
    </div>

    <!-- å¼•å…¥ MapLibre GL JS çš„ JavaScript -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

    <script>
      // ä½¿ç”¨ OpenFreeMap çš„ Liberty æ¨£å¼ï¼ˆåŸºæ–¼ OpenStreetMap æ•¸æ“šï¼‰
      // é€™æ˜¯ä¸€å€‹å…è²»é–‹æºçš„çŸ¢é‡åœ–å¡Šæ¨£å¼ï¼Œæ”¯æ´ 3D å»ºç¯‰ç‰©
      const styleUrl = "https://tiles.openfreemap.org/styles/liberty";
      // const DATA_PATH = "./original"; // åŸå§‹è³‡æ–™.
      const DATA_PATH = "./simplified"; // å£“ç¸®è³‡æ–™.

      // 1. åˆå§‹åŒ–åœ°åœ–
      const map = new maplibregl.Map({
        container: "map", // å°æ‡‰ HTML ID
        style: styleUrl, // åœ°åœ–æ¨£å¼
        center: [120.98760921351077, 23.668070137039763], // [ç¶“åº¦, ç·¯åº¦]
        zoom: 7, // åˆå§‹ç¸®æ”¾å±¤ç´š
        pitch: 0, // â˜… é—œéµï¼šåˆå§‹å‚¾æ–œè§’åº¦ (0-85)
        bearing: 0, // â˜… é—œéµï¼šåˆå§‹æ—‹è½‰è§’åº¦ (æ–¹ä½è§’)
        antialias: true, // é–‹å•ŸæŠ—é‹¸é½’ï¼Œè®“ 3D é‚Šç·£æ›´å¹³æ»‘
      });

      // District state management
      const districtState = {
        isDistrictVisible: false,
        currentCounty: null,
        districtSourceId: "district-data",
        countyIndexMap: null,
      };

      // 2. åŠ å…¥å°èˆªæ§åˆ¶é … (ç¸®æ”¾ã€æŒ‡åŒ—é‡)
      map.addControl(
        new maplibregl.NavigationControl({
          visualizePitch: true, // è®“æŒ‡åŒ—é‡é¡¯ç¤ºå‚¾æ–œç‹€æ…‹
        }),
        "top-right"
      );

      // 3. åŠ å…¥ä¸€å€‹æ¨™è¨˜ (Marker)
      // const popup = new maplibregl.Popup({ offset: 25 })
      //     .setHTML('<h3 class="font-bold text-lg">å°åŒ— 101</h3>');

      // new maplibregl.Marker({ color: "#EF4444" })
      //     .setLngLat([121.5645, 25.0336])
      //     .setPopup(popup)
      //     .addTo(map);

      // 4. ç•¶åœ°åœ–æ¨£å¼åŠ è¼‰å®Œæˆå¾Œï¼ŒåŠ å…¥ 3D å»ºç¯‰ç‰©åœ–å±¤å’Œç¸£å¸‚é‚Šç•Œ
      map.on("load", () => {
        // åŠ å…¥å°ç£ç¸£å¸‚é‚Šç•Œ GeoJSON æ•¸æ“šæº
        // ä½¿ç”¨ promoteId å°‡ COUNTYSN å±¬æ€§æå‡ç‚º feature id
        map.addSource("taiwan-cities", {
          type: "geojson",
          data: `${DATA_PATH}/twCounty2010.geo.json`,
          // data: "https://dev-leju-storage-public.s3.ap-northeast-2.amazonaws.com/frontend/twgeojson/town-geojson/twCounty2010.geo.json",
          promoteId: "COUNTYSN",
        });

        // ç‚ºäº†è®“å»ºç¯‰ç‰©æ–‡å­—é¡¯ç¤ºåœ¨å»ºç¯‰ç‰©ä¸Šæ–¹ï¼Œæˆ‘å€‘éœ€è¦æ‰¾åˆ°åœ–å±¤é †åºä¸­çš„æ–‡å­—å±¤
        const layers = map.getStyle().layers;
        let labelLayerId;
        for (let i = 0; i < layers.length; i++) {
          if (layers[i].type === "symbol" && layers[i].layout["text-field"]) {
            labelLayerId = layers[i].id;
            break;
          }
        }

        // åŠ å…¥ 3D å»ºç¯‰ç‰©åœ–å±¤
        // é€™æ˜¯å°‡å¹³é¢çš„å‘é‡åœ–ç£šä¾ç…§ 'render_height' æˆ– 'height' å±¬æ€§æ‹‰é«˜
        map.addLayer(
          {
            id: "3d-buildings",
            source: "openmaptiles", // æ³¨æ„ï¼šéœ€å°æ‡‰ style.json è£¡çš„ source åç¨±
            "source-layer": "building",
            filter: ["==", "extrude", "true"], // åªç¯©é¸æœ‰æ“ å£“å±¬æ€§çš„å»ºç¯‰
            type: "fill-extrusion",
            minzoom: 15, // æ‹‰è¿‘åˆ°é€™å€‹å±¤ç´šæ‰é¡¯ç¤º 3D
            paint: {
              // å»ºç¯‰ç‰©é¡è‰²
              "fill-extrusion-color": "#aaa",

              // â˜… é—œéµï¼šå¾è³‡æ–™å±¬æ€§ä¸­è®€å–é«˜åº¦
              "fill-extrusion-height": [
                "interpolate",
                ["linear"],
                ["zoom"],
                15,
                0,
                15.05,
                ["get", "render_height"], // æˆ–æ˜¯ 'height'ï¼Œè¦–åœ–è³‡ä¾†æºè€Œå®š
              ],

              // å»ºç¯‰ç‰©åº•åº§é«˜åº¦ï¼ˆå¦‚æœæ˜¯è“‹åœ¨ç©ºä¸­çš„å»ºç¯‰ï¼‰
              "fill-extrusion-base": [
                "interpolate",
                ["linear"],
                ["zoom"],
                15,
                0,
                15.05,
                ["get", "render_min_height"],
              ],

              // é€æ˜åº¦
              "fill-extrusion-opacity": 0.8,
            },
          },
          labelLayerId // å°‡æ­¤åœ–å±¤æ’å…¥åˆ°æ–‡å­—æ¨™ç±¤åœ–å±¤çš„ä¸‹æ–¹
        );

        // åŠ å…¥ç¸£å¸‚é‚Šç•Œå¡«å……åœ–å±¤
        map.addLayer({
          id: "cities-fill",
          type: "fill",
          source: "taiwan-cities",
          maxzoom: 14,
          paint: {
            "fill-color": "#088",
            "fill-opacity": [
              "case",
              ["boolean", ["feature-state", "hover"], false],
              0.3,
              0.1,
            ],
          },
        });

        // åŠ å…¥ç¸£å¸‚é‚Šç•Œç·šæ¢åœ–å±¤
        map.addLayer({
          id: "cities-outline",
          type: "line",
          source: "taiwan-cities",
          maxzoom: 14,
          paint: {
            "line-color": "#088",
            "line-width": 2,
            "line-opacity": 0.8,
          },
        });

        // åŠ å…¥ç¸£å¸‚åç¨±æ¨™ç±¤åœ–å±¤
        map.addLayer({
          id: "cities-labels",
          type: "symbol",
          source: "taiwan-cities",
          maxzoom: 14,
          layout: {
            "text-field": ["get", "name"],
            "text-font": ["Noto Sans Regular"],
            "text-size": 14,
            "text-offset": [0, 0],
            "text-anchor": "center",
          },
          paint: {
            "text-color": "#088",
            "text-halo-color": "#ffffff",
            "text-halo-width": 2,
          },
        });

        // Load county-to-filename index for districts
        async function loadCountyIndex() {
          const response = await fetch(`${DATA_PATH}/index.json`);
          const data = await response.json();
          districtState.countyIndexMap = data.counties;
        }

        // Initialize district system
        loadCountyIndex().catch((err) =>
          console.error("Failed to load county index:", err)
        );

        // åŠ å…¥ç¸£å¸‚é‚Šç•Œçš„ hover äº’å‹•æ•ˆæœ
        let hoveredCityId = null;

        map.on("mousemove", "cities-fill", (e) => {
          if (e.features.length > 0) {
            const featureId = e.features[0].id;

            // åªæœ‰ç•¶ feature æœ‰ id æ™‚æ‰ä½¿ç”¨ setFeatureState
            if (featureId !== undefined) {
              if (hoveredCityId !== null) {
                map.setFeatureState(
                  { source: "taiwan-cities", id: hoveredCityId },
                  { hover: false }
                );
              }
              hoveredCityId = featureId;
              map.setFeatureState(
                { source: "taiwan-cities", id: hoveredCityId },
                { hover: true }
              );
            }
          }
        });

        map.on("mouseleave", "cities-fill", () => {
          if (hoveredCityId !== null) {
            map.setFeatureState(
              { source: "taiwan-cities", id: hoveredCityId },
              { hover: false }
            );
          }
          hoveredCityId = null;
        });

        // æ”¹è®Šé¼ æ¨™æŒ‡é‡æ¨£å¼
        map.on("mouseenter", "cities-fill", () => {
          map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "cities-fill", () => {
          map.getCanvas().style.cursor = "";
        });

        // é»æ“Šç¸£å¸‚é¡¯ç¤º Popup ä¸¦ zoom inï¼Œä¸¦è¼‰å…¥è¡Œæ”¿å€
        map.on("click", "cities-fill", async (e) => {
          // Check if districts are visible and click is on a district
          if (districtState.isDistrictVisible) {
            const districtFeatures = map.queryRenderedFeatures(e.point, {
              layers: ["district-fill"],
            });
            if (districtFeatures.length > 0) {
              // Click is on a district, don't show county popup
              return;
            }
          }

          if (e.features.length > 0) {
            const feature = e.features[0];
            const cityName = feature.properties.name;
            const countyCode = feature.properties.COUNTYSN;

            // è¨ˆç®— feature çš„é‚Šç•Œ
            const coordinates = feature.geometry.coordinates;
            const bounds = new maplibregl.LngLatBounds();

            // æ ¹æ“š geometry é¡å‹è™•ç†åº§æ¨™
            const processCoordinates = (coords) => {
              if (typeof coords[0] === "number") {
                // å–®å€‹åº§æ¨™é» [lng, lat]
                bounds.extend(coords);
              } else {
                // éè¿´è™•ç†å·¢ç‹€é™£åˆ—
                coords.forEach((coord) => processCoordinates(coord));
              }
            };

            processCoordinates(coordinates);

            // Zoom in åˆ°è©²ç¸£å¸‚çš„é‚Šç•Œï¼ŒåŠ å…¥ padding è®“è¦–è¦ºæ›´èˆ’é©
            map.fitBounds(bounds, {
              padding: { top: 50, bottom: 50, left: 50, right: 50 },
              duration: 1000, // å‹•ç•«æŒçºŒæ™‚é–“
              pitch: 45, // åŠ å…¥ä¸€é»å‚¾æ–œæ•ˆæœ
            });

            // Load and display districts
            try {
              const districtData = await loadDistrictData(cityName);
              showDistricts(districtData);
              districtState.isDistrictVisible = true;
              districtState.currentCounty = cityName;
            } catch (error) {
              console.error("Failed to load districts:", error);
              new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(
                  `
                                <div class="text-red-600">
                                    <p class="font-bold text-sm">âš ï¸ éŒ¯èª¤</p>
                                    <p class="text-xs mt-1">ç„¡æ³•è¼‰å…¥è¡Œæ”¿å€è³‡æ–™</p>
                                </div>
                            `
                )
                .addTo(map);
            }
          }
        });

        // District hover effects
        let hoveredDistrictId = null;

        map.on("mousemove", "district-fill", (e) => {
          if (e.features.length > 0) {
            const featureId = e.features[0].id;
            if (featureId !== undefined) {
              if (hoveredDistrictId !== null) {
                map.setFeatureState(
                  { source: "district-data", id: hoveredDistrictId },
                  { hover: false }
                );
              }
              hoveredDistrictId = featureId;
              map.setFeatureState(
                { source: "district-data", id: hoveredDistrictId },
                { hover: true }
              );
            }
          }
        });

        map.on("mouseleave", "district-fill", () => {
          if (hoveredDistrictId !== null) {
            map.setFeatureState(
              { source: "district-data", id: hoveredDistrictId },
              { hover: false }
            );
          }
          hoveredDistrictId = null;
        });

        map.on("mouseenter", "district-fill", () => {
          map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", "district-fill", () => {
          map.getCanvas().style.cursor = "";
        });

        // District click handler
        map.on("click", "district-fill", (e) => {
          if (e.features.length > 0) {
            const feature = e.features[0];
            const districtName = feature.properties.TOWNNAME;

            // Calculate bounds and zoom
            const bounds = calculateBounds(feature.geometry.coordinates);
            map.fitBounds(bounds, {
              padding: 80,
              duration: 800,
              pitch: 30,
              maxZoom: 14,
            });

            // Show popup
            new maplibregl.Popup()
              .setLngLat(e.lngLat)
              .setHTML(`<h3 class="font-bold text-base">${districtName}</h3>`)
              .addTo(map);
          }
        });

        // Background click handler - remove districts when clicking outside
        map.on("click", (e) => {
          const features = map.queryRenderedFeatures(e.point, {
            layers: ["district-fill", "cities-fill"],
          });

          // If no features clicked and districts are visible, remove them
          if (features.length === 0 && districtState.isDistrictVisible) {
            removeDistricts();
            resetToTaiwanView();
          }
        });
      });

      // --- ä»¥ä¸‹æ˜¯åŠŸèƒ½å‡½å¼ ---

      // åŠŸèƒ½ï¼šé‡ç½®è¦–è§’ (å°åŒ—101è¿‘æ™¯)
      function resetView() {
        map.flyTo({
          center: [121.5645, 25.0336],
          zoom: 16.5,
          pitch: 60,
          bearing: -20,
          essential: true, // ç¢ºä¿å‹•ç•«å„ªå…ˆåŸ·è¡Œ
        });
      }

      // åŠŸèƒ½ï¼šå›åˆ°åˆå§‹é è¨­è¦–è§’
      function resetToInitialView() {
        removeDistricts(); // Remove districts if visible
        map.flyTo({
          center: [120.98760921351077, 23.668070137039763],
          zoom: 7,
          pitch: 0,
          bearing: 0,
          essential: true,
        });
      }

      // åŠŸèƒ½ï¼šè‡ªå‹•æ—‹è½‰å‹•ç•«
      let isRotating = false;
      function rotateCamera(timestamp) {
        if (!isRotating) {
          // é–‹å§‹æ—‹è½‰
          isRotating = true;
          function frame() {
            if (!isRotating) return;
            // æ¯æ¬¡ç§»å‹• 0.2 åº¦
            map.rotateTo((map.getBearing() + 0.2) % 360, { duration: 0 });
            requestAnimationFrame(frame);
          }
          frame();
        } else {
          // åœæ­¢æ—‹è½‰
          isRotating = false;
          // åœæ­¢æ™‚çš„ç·©è¡
          map.stop();
        }
      }

      // --- District Management Functions ---

      // Calculate bounds from geometry coordinates
      function calculateBounds(coordinates) {
        const bounds = new maplibregl.LngLatBounds();

        const processCoordinates = (coords) => {
          if (typeof coords[0] === "number") {
            bounds.extend(coords);
          } else {
            coords.forEach((coord) => processCoordinates(coord));
          }
        };

        processCoordinates(coordinates);
        return bounds;
      }

      // Load district GeoJSON data
      async function loadDistrictData(countyName) {
        // Normalize county name (è‡º â†’ å°)
        const normalizedName = countyName.replace(/è‡º/g, "å°");

        // Look up filename from index
        const filename = districtState.countyIndexMap[normalizedName];
        if (!filename) {
          throw new Error(`No district data found for ${countyName}`);
        }

        // Fetch GeoJSON
        const response = await fetch(`${DATA_PATH}/${filename}.geo.json`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
      }

      // Add district layers to map
      function addDistrictLayers() {
        const beforeLayerId = "cities-labels";

        // Fill layer
        map.addLayer(
          {
            id: "district-fill",
            type: "fill",
            source: "district-data",
            maxzoom: 14,
            layout: { visibility: "none" },
            paint: {
              "fill-color": "#0066CC",
              "fill-opacity": [
                "case",
                ["boolean", ["feature-state", "hover"], false],
                0.35,
                0.15,
              ],
            },
          },
          beforeLayerId
        );

        // Outline layer
        map.addLayer(
          {
            id: "district-outline",
            type: "line",
            source: "district-data",
            maxzoom: 14,
            layout: { visibility: "none" },
            paint: {
              "line-color": "#0066CC",
              "line-width": 1.5,
              "line-opacity": 0.9,
            },
          },
          beforeLayerId
        );

        // Label layer
        map.addLayer(
          {
            id: "district-labels",
            type: "symbol",
            source: "district-data",
            minzoom: 10,
            maxzoom: 14,
            layout: {
              visibility: "none",
              "text-field": ["get", "TOWNNAME"],
              "text-font": ["Noto Sans Regular"],
              "text-size": 12,
              "text-anchor": "center",
            },
            paint: {
              "text-color": "#0066CC",
              "text-halo-color": "#ffffff",
              "text-halo-width": 2,
            },
          },
          beforeLayerId
        );
      }

      // Show district layers
      function showDistricts(geojsonData) {
        // Add or update source
        if (!map.getSource("district-data")) {
          map.addSource("district-data", {
            type: "geojson",
            data: geojsonData,
            promoteId: "TOWNSN",
          });
        } else {
          map.getSource("district-data").setData(geojsonData);
        }

        // Add layers if they don't exist
        if (!map.getLayer("district-fill")) {
          addDistrictLayers();
        }

        // Show layers
        map.setLayoutProperty("district-fill", "visibility", "visible");
        map.setLayoutProperty("district-outline", "visibility", "visible");
        map.setLayoutProperty("district-labels", "visibility", "visible");
      }

      // Hide district layers
      function removeDistricts() {
        if (map.getLayer("district-fill")) {
          map.setLayoutProperty("district-fill", "visibility", "none");
          map.setLayoutProperty("district-outline", "visibility", "none");
          map.setLayoutProperty("district-labels", "visibility", "none");
        }

        districtState.isDistrictVisible = false;
        districtState.currentCounty = null;
      }

      // Reset to full Taiwan view
      function resetToTaiwanView() {
        map.flyTo({
          center: [120.98760921351077, 23.668070137039763],
          zoom: 7,
          pitch: 0,
          bearing: 0,
          duration: 1200,
          essential: true,
        });
      }
    </script>
  </body>
</html>
